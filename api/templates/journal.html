<script>
    const logoutButton = document.getElementById("logoutButton");

    logoutButton.addEventListener("click", logout);

    async function logout() {
        try {
            await fetch("https://ephemerismea.com/logout", {
                method: "POST",
                credentials: "include"
            });
        } catch (error) {
            console.error("Logout failed", error);
        } finally {
            window.location.href = "https://ephemerismea.com";
        }
    }

    function updateCharCount(id, max) {
        const input = document.getElementById(id);
        const counter = document.getElementById(`${id}-count`);
        input.addEventListener("input", () => {
            counter.textContent = `${input.value.length} / ${max}`;
        });
    }

    updateCharCount("work", 255);
    updateCharCount("struggle", 255);
    updateCharCount("intention", 255);

    const form = document.getElementById("entryForm");
    const messageDiv = document.getElementById("message");
    const entriesDiv = document.getElementById('entries');

    async function fetchAndDisplayEntries(url) {
        try {
            const response = await fetch(url, {
                credentials: "include"
            });
            const entries = await response.json();

            entriesDiv.innerHTML = "";

            entries.forEach(entry => {
                const e = entry.data;
                const entryElement = document.createElement('div');
                entryElement.classList.add('entry');
                entryElement.innerHTML = `
                    <div><strong>Work:</strong><br>${e.work || ''}</div>
                    <div><strong>Struggle:</strong><br>${e.struggle || ''}</div>
                    <div><strong>Intention:</strong><br>${e.intention || ''}</div>
                    <small><em>Created: ${e.created_at || 'Unknown'}</em></small>
                `;
                entriesDiv.appendChild(entryElement);
            });
        } catch (error) {
            console.error("Failed to fetch entries:", error);
        }
    }

    fetchAndDisplayEntries("https://ephemerismea.com/entries");

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const entryData = {
            work: form.work.value,
            struggle: form.struggle.value,
            intention: form.intention.value
        };

        try {
            const response = await fetch("https://ephemerismea.com/entries/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(entryData),
                credentials: "include"
            });

            if (response.status === 201) {
                messageDiv.textContent = "Entry submitted successfully!";
                messageDiv.style.color = "green";
                form.reset();
                fetchAndDisplayEntries("https://ephemerismea.com/entries");
            } else {
                const error = await response.json();
                messageDiv.textContent = `Error: ${error.detail || "Something went wrong"}`;
                messageDiv.style.color = "red";
            }
        } catch (err) {
            console.error(err);
            messageDiv.textContent = "Network error. Could not submit.";
            messageDiv.style.color = "red";
        }
    });
</script>
